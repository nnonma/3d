<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEMATODE: Triple Crisis 3D - Visibility Fix</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'MS Gothic', 'Courier New', monospace; color: #00ff00; touch-action: none; }
        #container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; font-size: 14px; text-shadow: 2px 2px #000; pointer-events: none; z-index: 100; opacity: 0; transition: opacity 1s; }
        #joystick-base { position: absolute; bottom: 40px; left: 40px; width: 80px; height: 80px; background: rgba(0, 255, 0, 0.1); border: 2px solid rgba(0, 255, 0, 0.5); border-radius: 50%; display: none; z-index: 200; touch-action: none; }
        #joystick-stick { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; background: rgba(0, 255, 0, 0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #dmg-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.4); pointer-events: none; z-index: 1000; opacity: 0; }
        #intro-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        #start-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 30px; text-align: center; z-index: 600; border: 1px solid #ff0000; display: none; }
        #logo { color: #f00; letter-spacing: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="container">
    <div id="intro-screen" onclick="handleIntroClick()">
        <div style="border:1px solid #0f0; padding:15px;">[ TAP TO START SYSTEM ]</div>
    </div>

    <div id="start-screen">
        <h1 id="logo">NEMATODE</h1>
        <button onclick="startGame()" style="padding:10px 20px; background:#000; color:#f00; border:1px solid #f00;">[ START ]</button>
    </div>

    <div id="ui">
        <div id="hearts">HP: ■■</div>
        <div id="status-text">LEVEL 1</div>
        <div>ARTIFACT: <span id="t-count">0</span>/3</div>
    </div>

    <div id="joystick-base"><div id="joystick-stick"></div></div>
    <div id="dmg-flash"></div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

let state = 'intro';
let currentLevel = 1;
let currentMap = 0;
let player = { hp: 2, maxHp: 2, hasT: false, saved: 0, invul: 0, pos: new THREE.Vector3(0, 0, 5), lastStep: 0 };
let enemies = [];
let footprints = [];
let audioCtx = null;
let touchInput = { x: 0, y: 0, active: false };

// --- Three.js Setup ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050505);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.getElementById('container').appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0xffffff, 0.2);
scene.add(ambient);
const pLight = new THREE.PointLight(0x00ff00, 20, 30); // 光を大幅に強化
scene.add(pLight);

const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(50, 50),
    new THREE.MeshStandardMaterial({ color: 0x111111 })
);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

const grid = new THREE.GridHelper(50, 10, 0x333333, 0x222222);
scene.add(grid);

// --- Investigator Character ---
const playerGroup = new THREE.Group();
const pBody = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.4), new THREE.MeshStandardMaterial({ color: 0x006600 }));
pBody.position.y = 0.6;
const pHead = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({ color: 0x00ff00 }));
pHead.position.y = 1.15;
const pPack = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.3), new THREE.MeshStandardMaterial({ color: 0x003300 }));
pPack.position.set(0, 0.6, -0.3);
const lFoot = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.15, 0.3), new THREE.MeshStandardMaterial({ color: 0x111111 }));
const rFoot = lFoot.clone();
lFoot.position.set(-0.2, 0.1, 0);
rFoot.position.set(0.2, 0.1, 0);

playerGroup.add(pBody, pHead, pPack, lFoot, rFoot);
playerGroup.position.copy(player.pos);
scene.add(playerGroup);

// --- Joystick ---
const joyBase = document.getElementById('joystick-base');
const joyStick = document.getElementById('joystick-stick');
joyBase.addEventListener('touchstart', (e) => { touchInput.active = true; updateJoy(e); });
joyBase.addEventListener('touchmove', (e) => { e.preventDefault(); updateJoy(e); }, {passive:false});
joyBase.addEventListener('touchend', () => { touchInput.active = false; touchInput.x = 0; touchInput.y = 0; joyStick.style.transform = 'translate(-50%, -50%)'; });

function updateJoy(e) {
    const touch = e.touches[0];
    const rect = joyBase.getBoundingClientRect();
    const dx = touch.clientX - (rect.left + rect.width / 2);
    const dy = touch.clientY - (rect.top + rect.height / 2);
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
    const angle = Math.atan2(dy, dx);
    touchInput.x = (Math.cos(angle) * dist) / 40;
    touchInput.y = (Math.sin(angle) * dist) / 40;
    joyStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
}

// --- Interaction ---
window.handleIntroClick = () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('intro-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'block';
};

window.startGame = () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('ui').style.opacity = '1';
    joyBase.style.display = 'block';
    state = 'play';
};

function animate() {
    requestAnimationFrame(animate);
    if(state === 'play') {
        let mvX = touchInput.x;
        let mvZ = touchInput.y;

        // キーボード操作も有効化
        const keys = {}; // 簡易化のため
        if (mvX === 0 && mvZ === 0) {
            // ここにキーボード処理が必要な場合は追加
        }

        if (Math.abs(mvX) > 0.1 || Math.abs(mvZ) > 0.1) {
            player.pos.x += mvX * 0.15;
            player.pos.z += mvZ * 0.15;
            const time = Date.now() * 0.01;
            pBody.position.y = 0.6 + Math.abs(Math.sin(time)) * 0.12;
            playerGroup.rotation.y = Math.atan2(mvX, mvZ);
        }

        playerGroup.position.copy(player.pos);
        pLight.position.set(player.pos.x, 3, player.pos.z);
        
        // カメラ位置をプレイヤーに追従 (少し高めから)
        camera.position.set(player.pos.x, 15, player.pos.z + 12);
        camera.lookAt(player.pos);
    }
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
